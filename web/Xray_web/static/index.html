<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>X-Ray AI 分析可视化</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container">
        <h1>X-Ray AI 分析可视化</h1>
        <p class="subtitle">用于验证 AI 异步分析接口的完整流程</p>
        
        <!-- 标签页切换 -->
        <div class="tab-container">
            <button class="tab-btn active" data-tab="analysis">AI 分析</button>
            <button class="tab-btn" data-tab="manual">手动可视化</button>
        </div>
        
        <!-- AI 分析标签页 -->
        <div class="tab-content active" id="tabAnalysis">
        <!-- 表单区域（保留 MVP 的表单结构） -->
        <div class="form-container">
            <!-- 任务类型选择 -->
            <div class="form-group">
                <label for="taskType">任务类型：</label>
                <select id="taskType">
                    <option value="panoramic">全景片 (Panoramic)</option>
                    <option value="cephalometric">侧位片 (Cephalometric)</option>
                    <option value="dental_age_stage">牙期检测 (Dental Age Stage)</option>
                </select>
            </div>

            <!-- 处理模式选择 -->
            <div class="form-group">
                <label>处理模式：</label>
                <div class="radio-group" style="display: flex; gap: 20px; align-items: center; margin-top: 5px;">
                    <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                        <input type="radio" name="syncMode" value="sync" checked> 
                        同步 (Sync)
                    </label>
                    <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                        <input type="radio" name="syncMode" value="async"> 
                        异步 (Async)
                    </label>
                </div>
                <p class="hint" style="margin-top: 5px;">同步模式直接返回结果，异步模式通过轮询获取结果</p>
            </div>
            
            <!-- 文件选择 -->
            <div class="form-group">
                <label for="imageFile">选择文件：</label>
                <input type="file" id="imageFile" accept=".jpg,.jpeg,.png">
                <p class="hint">支持格式：.jpg, .png</p>
            </div>
            
            <!-- 比例尺设置（可选） -->
            <div class="form-group">
                <label>比例尺设置（可选）：</label>
                <div class="pixel-spacing-fields">
                    <div class="field-item">
                        <label for="pixelSpacingX">X 方向 (mm/pixel)：</label>
                        <input type="number" id="pixelSpacingX" step="0.001" min="0" placeholder="0.1">
                    </div>
                    <div class="field-item">
                        <label for="pixelSpacingY">Y 方向 (mm/pixel)：</label>
                        <input type="number" id="pixelSpacingY" step="0.001" min="0" placeholder="0.1">
                    </div>
                </div>
                <p class="hint">留空则使用默认值 0.1 mm/pixel，或由后端从 DICOM 解析</p>
            </div>
            
            <!-- 患者信息表单（动态显示） -->
            <div id="patientInfoSection" class="form-group patient-info hidden">
                <label>患者信息（侧位片图片必填）：</label>
                <div class="patient-fields">
                    <div class="field-item">
                        <label for="gender">性别：</label>
                        <select id="gender">
                            <option value="">请选择性别</option>
                            <option value="Male">男性 (Male)</option>
                            <option value="Female">女性 (Female)</option>
                        </select>
                    </div>
                    <div class="field-item">
                        <label for="dentalStage">牙期：</label>
                        <select id="dentalStage">
                            <option value="">请选择牙期</option>
                            <option value="Permanent">恒牙期 (Permanent)</option>
                            <option value="Mixed">混合牙期 (Mixed)</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- 提交按钮 -->
            <div class="form-group">
                <button id="submitBtn" class="btn-primary">提交分析任务</button>
            </div>
        </div>
        </div>
        
        <!-- 手动可视化标签页 -->
        <div class="tab-content" id="tabManual">
            <div class="form-container">
                <div class="form-group">
                    <label for="manualImageFile">选择图片：</label>
                    <input type="file" id="manualImageFile" accept=".jpg,.jpeg,.png">
                    <p class="hint">支持格式：.jpg, .png</p>
                </div>
                
                <div class="form-group">
                    <label for="manualJsonFile">选择 JSON 结果文件：</label>
                    <input type="file" id="manualJsonFile" accept=".json">
                    <p class="hint">选择之前保存的 AI 分析结果 JSON 文件</p>
                </div>
                
                <div class="form-group">
                    <label>或直接粘贴 JSON：</label>
                    <textarea id="manualJsonText" rows="10" placeholder='支持两种格式：
1. 完整格式：{"taskId": "...", "status": "SUCCESS", "data": {...}}
2. 仅 data 字段：{"ToothAnalysis": [...], "JointAndMandible": {...}}'></textarea>
                </div>
                
                <div class="form-group">
                    <button id="manualVisualizeBtn" class="btn-primary">开始可视化</button>
                </div>
            </div>
        </div>
        
        <!-- 双栏布局容器 -->
        <div class="main-container hidden" id="mainContainer">
            <!-- 左侧: 图像查看区 -->
            <div class="image-container" id="imageContainer">
                <!-- Konva Canvas 将在这里动态创建 -->
            </div>
            
            <!-- 右侧: AI 分析报告区 -->
            <div class="report-container" id="reportContainer">
                <!-- 图层控制面板 -->
                <div class="layer-control-panel" id="layerControlPanel">
                    <div class="layer-control-header">
                        <h3>显示设置</h3>
                        <div class="layer-control-buttons">
                            <button class="btn-layer-control" id="hideAllBtn">全部隐藏</button>
                            <button class="btn-layer-control" id="showAllBtn">全部显示</button>
                        </div>
                    </div>
                    <div class="layer-list" id="layerList">
                        <!-- 图层列表将在这里动态生成 -->
                    </div>
                </div>

                <!-- 报告内容容器 -->
                <div id="reportContent">
                    <!-- 报告内容将在这里动态生成 -->
                </div>
            </div>
        </div>
        
        <!-- 错误提示区域 -->
        <div class="error-message hidden" id="errorMessage"></div>
        
        <!-- 加载指示器（保留 MVP 的 loadingIndicator） -->
        <div class="loading-indicator hidden" id="loadingIndicator">
            <div class="loading-spinner"></div>
            <p class="loading-text">正在处理中，请稍候...</p>
        </div>
    </div>
    
    <!-- 脚本引入 -->
    <script src="/static/lib/konva.min.js"></script>
    <script src="/static/app.js"></script>
</body>
</html>
