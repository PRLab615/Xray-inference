
---

# 需求文档：AI 异步分析前端 (MVP v4)

本文档定义了用于内部测试 的 AI 异步分析前端应用的最小可行产品（MVP）需求。

## 1. 核心目标与架构

* **目标：** 创建一个轻量级的前端测试页面，用于完整验证 `POST /api/v1/analyze` 接口的异步文件上传、任务处理和回调 流程。
* **架构：**
    1.  **微型回调服务器：** 前端将自行部署一个轻量级的“微型回调服务器”。此服务器在内网运行，用于接收 AI 后端（乙方）的回调 `POST` 请求。
    2.  **前端轮询 (方案A)：** 浏览器 UI 将采用轮询方式。在任务提交后，UI会定期（例如每3秒）向“微型回调服务器”发起 `GET` 请求，以检查结果是否已到达。

## 2. 完整用户流程 (v4)

这是从用户开始操作到完成任务并重置的完整闭环流程。

### 步骤 1：选择任务类型
用户在界面上首先选择 `taskType`（例如 "panoramic" 或 "cephalometric"）。

### 步骤 2：选择文件
* 用户在文件选择框中选择一个本地文件。
* **前端校验：** 界面必须限制用户**只能**选择允许的文件类型：图片（`.jpg`, `.png`）或 `.dcm` (DICOM) 文件。

### 步骤 3：动态表单（核心逻辑）
此步骤的行为**必须**根据任务类型和文件类型动态变化：

* **情况 A：侧位片 + 图片**
    * **如果** `taskType` 是 "cephalometric" **并且** 用户选择了 `.jpg` 或 `.png` 文件：
    * 前端UI**必须显示**“性别”和“牙期” (`patientInfo`) 的输入框。
    * “提交”按钮在这些信息被完整填写前应处于不可用状态。

* **情况 B：侧位片 + DICOM**
    * **如果** `taskType` 是 "cephalometric" **并且** 用户选择了 `.dcm` 文件：
    * 前端UI**不得**显示“性别”和“牙期”的输入框。系统假定后端将从DICOM中解析所需信息或不需要这些信息。

* **情况 C：其他**
    * 对于所有其他情况（例如 "panoramic"），不显示 `patientInfo` 输入框。

### 步骤 4：提交任务
* 用户点击“提交”。
* 前端UI以 `multipart/form-data` 格式 调用 `POST /api/v1/analyze`。
* `callbackUrl` 参数**必须**被设置为“微型回调服务器”的内网接收地址。
* 如果 `taskType` 是 "cephalometric" 且为图片，`patientInfo` 字段必须被正确填充并作为表单字段提交。

### 步骤 5：等待分析
* **立即响应：** 浏览器收到 `202 Accepted` 后，立即在界面上显示一个**简单的旋转图标**，表示“处理中”。
* **启动轮询：** **同时**，浏览器UI启动一个轮询计时器，开始定期（例如每3秒）向“微型回调服务器”发起 `GET /get-result?taskId=...` 请求，询问结果。

### 步骤 6：展示结果
* **停止轮询：** 一旦轮询请求成功获取到AI服务器回调的JSON结果，浏览器UI**必须立即停止**轮询计时器。
* **显示界面：** 旋转图标消失，界面在原处显示分析结果。
    * **成功：** 显示 `data` 字段中的关键信息（或原始JSON）。
    * **失败：** 显示 `error.displayMessage` 字段的内容（例如“图像质量过低”）。

### 步骤 7：复制结果
* 在结果（无论成功或失败）展示的同时，界面上提供一个**“复制”按钮**。
* **功能：** 点击该按钮，会将“微型回调服务器”接收到的**完整原始JSON响应体**（包含 `taskId`, `status`, `data`, `error` 等所有字段） 复制到用户的剪贴板。

### 步骤 8：自动重置流程
* **触发：** 当用户在**任何状态下**（无论是在等待、显示结果还是出错）**再次点击文件选择框并选择了新图片**时。
* **动作：** UI应**立即自动重置**：
    * 清除所有旧状态（旋转图标、缓存的JSON结果、`patientInfo` 输入框的内容）。
    * 隐藏“复制”按钮。
    * 流程返回至 **步骤 2**，准备提交新任务。

## 3. 关键异常处理

1.  **同步提交失败（4xx）**
    * **描述：** 在“步骤 4：提交任务”时，如果AI后端（乙方）**立即**返回 `HTTP 400 Bad Request`（例如，`patientInfo` 缺少字段）。
    * **处理：** 流程**不得**进入“步骤 5：等待分析”。必须立即在UI上显示 `error.displayMessage` 的内容。

2.  **异步轮询超时**
    * **描述：** 在“步骤 5：等待分析”时，如果前端轮询持续时间超过一个设定的阈值（例如 6 分钟，应略大于乙方的 5 分钟任务超时） 仍未从微型服务器获取到结果。
    * **处理：** 浏览器UI**必须停止**轮询，并向用户显示一个明确的错误信息，例如“任务超时，请重试或联系管理员”。