name: Violet's Report

on:
  push:
    branches: [ "main", "dev" ]

jobs:
  violet_notify:
    runs-on: ubuntu-latest
    steps:
      - name: Writing Letter to Feishu
        env:
          WEBHOOK_URL: ${{ secrets.FEISHU_WEBHOOK }}
        run: |
          # 1. è·å–åŸºç¡€ä¿¡æ¯
          COMMIT_MSG="${{ github.event.head_commit.message }}"
          AUTHOR="${{ github.actor }}"
          REPO="${{ github.repository }}"
          URL="${{ github.event.head_commit.url }}"
          REF="${{ github.ref }}"
          BRANCH=${REF#refs/heads/}

          # 2. å‡†å¤‡æ–‡æ¡ˆï¼šæ¸…çˆ½å®ç”¨é£æ ¼
          # æ ¸å¿ƒæ”¹åŠ¨ï¼š
          # - å¤§å¹…ç¼©å‡å¼€åœºç™½ï¼Œç›´æ¥è¿›å…¥æ­£é¢˜ã€‚
          # - ä½¿ç”¨ emoji ä½œä¸ºè§†è§‰å¼•å¯¼ï¼Œè®©æ’ç‰ˆæ›´åƒä¸€ä»½ä¸“ä¸šçš„â€œæŠ¥å‘Šä¹¦â€ã€‚
          # - å¿…é¡»ä¿ç•™ "GitHub" å…³é”®è¯ã€‚

          TEXT_CONTENT="æŠ¥å‘Šå°‘ä½ï¼ŒGitHub æˆ˜çº¿ä¼ æ¥æœ€æ–°çš„ä»£ç å˜æ›´è®°å½•ã€‚
          
          ğŸ“¦ **é¡¹ç›®**ï¼š$REPO
          ğŸŒ¿ **åˆ†æ”¯**ï¼š$BRANCH
          ğŸ‘¤ **æäº¤äºº**ï¼š$AUTHOR
          
          ğŸ“ **å˜æ›´å†…å®¹**ï¼š
          $COMMIT_MSG
          
          ğŸ”— **æŸ¥çœ‹è¯¦æƒ…**ï¼š
          $URL
          
          è‡ªåŠ¨æ‰‹è®°äººå¶ è–‡å°”è‰ç‰¹Â·ä¼ŠèŠ™åŠ ç™»ï¼Œæ±‡æŠ¥å®Œæ¯•ã€‚(bow)"

          # 3. ä½¿ç”¨ jq ç”Ÿæˆæ ‡å‡† JSON (æ ¸å¿ƒé˜²é”™æœºåˆ¶)
          JSON_PAYLOAD=$(jq -n \
            --arg text "$TEXT_CONTENT" \
            '{msg_type: "text", content: {text: $text}}')

          # 4. å‘é€
          curl -X POST -H "Content-Type: application/json" \
            -d "$JSON_PAYLOAD" \
            "$WEBHOOK_URL"