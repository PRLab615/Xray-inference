# v5 气道腺体 11 点集成说明

> 本文档记录了侧位片气道/腺体 11 点位检测模块的集成过程和实现细节。

---

## 📋 需求背景

根据《腺体气道集成与后处理说明.md》，甲方要求新增 11 个气道/腺体相关标志点的预测，用于：
- **5 个气道测量**：PNS-UPW, SPP-SPPW, U-MPW, TB-TPPW, V-LPW
- **腺样体 A/N 比值**：评估腺样体肥大情况

---

## 📁 新增文件

### 1. `pipelines/ceph/modules/point_11/` 模块

| 文件 | 说明 |
|------|------|
| `__init__.py` | 模块初始化，导出 `LandmarkResult11`, `Point11Model` |
| `pre_post.py` | 定义 11 点名称列表 + 前后处理函数 |
| `point_11_model.py` | `LandmarkResult11` 数据类 + `Point11Model` YOLO 封装 |

### 2. 11 点位名称清单

```python
KEYPOINT_NAMES_11 = [
    "U",      # 悬雍垂尖
    "V",      # 会咽谷点
    "UPW",    # 上咽壁点
    "SPP",    # 软腭前点
    "SPPW",   # 软腭后咽壁点
    "MPW",    # 中咽壁点
    "LPW",    # 下咽壁点
    "TB",     # 舌根点
    "TPPW",   # 舌咽部后气道点
    "AD",     # 腺样体最凸点
    "Dprime", # 翼板与颅底交点 (D')
]
```

---

## 🔧 修改的文件

### 1. `config.yaml`

新增 `point_11` 模块配置：

```yaml
cephalometric:
  modules:
    point_11:
      description: "气道/腺体标志点检测模型（11点）"
      weights_key: "weights/cephalometric/TODO_point_11.pt"  # TODO: 待填写
      weights_force_download: false
      device: "0"
      image_size: 1024
      conf: 0.25
      iou: 0.6
      max_det: 1
```

### 2. `pipelines/ceph/ceph_pipeline.py`

- 导入 `Point11Model` 和气道/腺体计算函数
- 新增 `_init_point_11_module()` 初始化方法
- 在 `run()` 中新增 **步骤 2: Point_11 模块推理**
- 调用 `calculate_airway_measurements()` 和 `calculate_adenoid_ratio()`
- 将结果合并到 `inference_results`

### 3. `pipelines/ceph/utils/ceph_report.py`

新增常量和函数：

```python
# 11 点映射
KEYPOINT_MAP_11 = {
    "U": "U", "V": "V", "UPW": "UPW", "SPP": "SPP", "SPPW": "SPPW",
    "MPW": "MPW", "LPW": "LPW", "TB": "TB", "TPPW": "TPPW",
    "AD": "AD", "Dprime": "D'"
}

# 气道正常值参考
AIRWAY_NORMAL_VALUES = {
    "PNS-UPW": (28.4, 3.0),   # 鼻咽段
    "SPP-SPPW": (13.2, 2.6),  # 口咽段-腭咽段
    "U-MPW": (11.6, 2.9),     # 口咽段-腭咽段
    "TB-TPPW": (13.3, 3.2),   # 口咽段-舌咽段
    "V-LPW": (18.7, 3.7),     # 喉咽段
}

# A/N 比值阈值
ADENOID_AN_THRESHOLD = 0.7  # < 0.7 正常

# 新增函数
def calculate_airway_measurements(landmarks_25, landmarks_11, spacing): ...
def calculate_adenoid_ratio(landmarks_25, landmarks_11, spacing): ...
```

### 4. `pipelines/ceph/utils/ceph_report_json.py`

- 更新 `LABEL_FULL_NAMES` 添加 11 点完整名称
- 更新 `MEASUREMENT_ORDER` 包含 `Airway_Gap` 和 `Adenoid_Index`
- 新增 `_build_landmark_11_section()` 构建 11 点输出
- 新增 `_build_adenoid_entry()` 构建腺体输出
- 更新 `generate_standard_output()` 输出 `AirwayLandmarkPositions`

### 5. `pipelines/ceph/utils/ceph_recalculate.py`

- 导入 `KEYPOINT_MAP_11` 和气道/腺体计算函数
- 新增 `FULL_NAME_TO_KEY_11` 反向映射
- 新增 `_convert_landmarks_11()` 函数
- 更新 `recalculate_ceph_report()` 支持 11 点重计算

---

## 🔗 数据流

```
config.yaml (point_11 模块配置)
    ↓
ceph_pipeline._initialize_modules() → 初始化 Point11Model
    ↓
ceph_pipeline.run()
    ├── 步骤1: 25点推理 → inference_results["landmarks"]
    ├── 步骤2: 11点推理 → inference_results["landmarks_11"]
    │       ├── calculate_airway_measurements() → measurements["Airway_Gap"]
    │       └── calculate_adenoid_ratio() → measurements["Adenoid_Index"]
    ├── 步骤3: CVM推理（可选）
    ↓
generate_standard_output()
    ├── _build_landmark_section() → LandmarkPositions (25点)
    ├── _build_landmark_11_section() → AirwayLandmarkPositions (11点)
    └── _build_measurement_section_in_order() → AllMeasurements
```

---

## 📦 输出 JSON 结构

### 新增 `AirwayLandmarkPositions` 节点

```json
{
  "AirwayLandmarkPositions": {
    "TotalLandmarks": 11,
    "DetectedLandmarks": 11,
    "MissingLandmarks": 0,
    "Landmarks": [
      {"Label": "Uvula tip", "X": 123, "Y": 456, "Confidence": 0.95, "Status": "Detected"},
      {"Label": "Vallecula", "X": 234, "Y": 567, "Confidence": 0.92, "Status": "Detected"},
      {"Label": "Upper Pharyngeal Wall", ...},
      {"Label": "Soft Palate Point", ...},
      {"Label": "Soft Palate Pharyngeal Wall", ...},
      {"Label": "Middle Pharyngeal Wall", ...},
      {"Label": "Lower Pharyngeal Wall", ...},
      {"Label": "Tongue Base", ...},
      {"Label": "Tongue Posterior Pharyngeal Wall", ...},
      {"Label": "Adenoid", ...},
      {"Label": "D prime", ...}
    ]
  }
}
```

### 新增气道测量项 `Airway_Gap`

```json
{
  "Label": "Airway_Gap",
  "PNS-UPW": 28.0,      // 后鼻棘-咽后壁距离 (mm)
  "SPP-SPPW": 13.0,     // 软腭尖-咽后壁距离 (mm)
  "U-MPW": 11.5,        // 悬雍垂-咽后壁距离 (mm)
  "TB-TPPW": 13.0,      // 舌根-咽后壁距离 (mm)
  "V-LPW": 18.0,        // 会厌-咽后壁距离 (mm)
  "Level": true,        // true=正常, false=不足
  "Confidence": 0.86
}
```

### 新增腺样体指数 `Adenoid_Index`

```json
{
  "Label": "Adenoid_Index",
  "Value": 0.52,        // A/N 比值
  "Level": true,        // true=未见肿大(<0.7), false=肿大(>=0.7)
  "Confidence": 0.85
}
```

---

## 📐 计算公式

### 气道测量（5 项）

| 测量项 | 点位依赖 | 公式 |
|--------|----------|------|
| PNS-UPW | PNS(25点), UPW(11点) | Distance(PNS, UPW) |
| SPP-SPPW | SPP, SPPW(11点) | Distance(SPP, SPPW) |
| U-MPW | U, MPW(11点) | Distance(U, MPW) |
| TB-TPPW | TB, TPPW(11点) | Distance(TB, TPPW) |
| V-LPW | V, LPW(11点) | Distance(V, LPW) |

### 腺样体 A/N 比值

| 参数 | 点位依赖 | 公式 |
|------|----------|------|
| A (厚度) | AD, Ba, Ar | 垂直距离(AD, Line(Ba, Ar)) |
| N (深度) | PNS, Dprime | Distance(PNS, Dprime) |
| A/N | A, N | A / N |

**判断标准**：
- A/N < 0.7 → 正常（Level=true）
- A/N ≥ 0.7 → 肿大（Level=false）

---

## ⚠️ 待办事项

```yaml
# config.yaml 第156行
point_11:
  weights_key: "weights/cephalometric/TODO_point_11.pt"  # ← 替换为实际权重路径
```

**一旦权重路径正确配置，整个流程将自动工作。**

---

## 📝 重计算支持

`ceph_recalculate.py` 已更新，支持以下因果关系：

**"因"字段（从 input_data 提取）**：
- `LandmarkPositions.Landmarks[*]` → 25 点坐标
- `AirwayLandmarkPositions.Landmarks[*]` → 11 点坐标

**"果"字段（重新计算）**：
- 所有 25 点相关测量值
- `Airway_Gap` → 5 个气道距离
- `Adenoid_Index` → A/N 比值

---

## 📅 更新记录

| 日期 | 版本 | 内容 |
|------|------|------|
| 2025-01-XX | v5.0 | 新增气道/腺体 11 点位检测模块 |

