
1 通用系统规范 

本规范定义了 AI 分析服务的通用技术标准，旨在确保服务调用方（甲方）与服务提供方（乙方）之间通信的标准化、可靠性、安全性和弹性。
所有 AI 分析接口（包括但不限于全景片、侧位片）均须遵守本规范。
1.1 接口状态码 

HTTP 状态码用于表示 API 接口请求的宏观结果。
暂时无法在飞书文档外展示此内容

 1.2 业务错误码 
业务错误码是对 4xx 和 5xx 状态码的详细补充，用于在同步响应或异步回调中提供具体的失败原因。

 1.2.1 错误响应体 
所有错误响应（包括同步4xx/5xx和异步回调的error字段）均使用此结构：
{
  "code": 11001, // 唯一的数字错误码
  "message": "Image file is corrupted or unreadable.", // 给开发者的调试信息
  "displayMessage": "图像文件已损坏或无法读取" // 可直接展示给终端用户的提示
}

 1.2.2 错误码定义表
暂时无法在飞书文档外展示此内容

---

1.3 异步任务与回调规范 

由于 AI 分析耗时较长，所有分析任务均采用异步回调机制。
1.3.1 任务提交流程 
1. [甲方] 统一调用 POST /api/v1/analyze  (Endpoint) 来提交所有类型的分析任务。
2. [甲方] 在 Request Body 中必须包含 taskType 字段以区分任务，并根据任务类型提供相应参数。
  - taskType: (必填) 字符串。用于指定分析类型。
    - "panoramic": 全景片分析
    - "cephalometric": 侧位片分析
3.  提交任务 
4. 任务进度
当taskType为cephalometric （侧位片），必须同时接收到患者性别信息，牙期信息(恒牙期还是替牙期)，参考下述标黄区域
当TaskType为panoramic(全景片)，可以省略patientInfo字段
{
   "taskId": "task-uuid-a1b2c3d4-xxxx-yyyy-zzzz",
  "taskType": "cephalometric", 
  "imageUrl": "https://example.com/images/pano-001.jpg",
  "callbackUrl": "https://api.jiǎfang.com/v1/ai-callback",
  "patientInfo": { 
       "gender": "Male", // 可选:Male(男性)/Female(女性)
       "DentalAgeStage": "Permanent" //可选: Permanent(恒牙期)/Mixed(替牙期)
   },
  "metadata": { 
    "patientId": "P-12345",
    "orderId": "O-67890"
  }
}
1. [乙方] 同步验证请求。
  - 乙方将首先检查 taskType 字段。
  - 如果 taskType 为 "cephalometric"，乙方将额外验证 patientInfo.gender（患者性别信息，牙期信息(恒牙期还是替牙期)） 是否存在。
  - 验证通过 (成功): 立即返回 HTTP 202 Accepted，并在 Body 中提供任务 ID。
  - 改变任务状态 (Status) = QUEUED
// HTTP 202 Accepted 的响应体
{
  "taskId": "task-uuid-a1b2c3d4-xxxx-yyyy-zzzz",
  "status": "QUEUED", // 状态: 已入队
  "submittedAt": "2025-10-28T14:30:00Z",
  "metadata": { 
    "patientId": "P-12345",
    "orderId": "O-67890"
  }
}
  - 验证失败 (失败): 立即返回 HTTP 400 (或其他 4xx)，并在 Body 中提供错误响应体 (见 1.2.2)。
    - 示例 (缺少 taskType):
// HTTP 400 Bad Request
{
  "code": 10001,
  "message": "Invalid parameter 'taskType', must be provided.",
  "displayMessage": "请求参数错误：必须提供 'taskType' 字段"
}
    - 示例 (侧位片任务缺少性别):
// HTTP 400 Bad Request
{
  "code": 10001,
  "message": "Invalid parameter 'patientInfo.gender', must be provided when taskType is 'cephalometric'.",
  "displayMessage": "请求参数错误：侧位片任务必须提供患者性别"
}

1.3.2 任务回调请求 
任务（成功或失败）后，乙方将向甲方提交的 callbackUrl 发送一个 POST 请求。
- Method: POST
- Headers:
  - Content-Type: application/json
  - X-Timestamp: 1678886400 (回调发出的 Unix 时间戳 (秒))


1.3.3 回调 Body - Data 与 Error
A. 状态 (Status) = SUCCESS
- error 字段为 null。
- data 字段将完整包含《规范 ：全景片JSON)》或《规范：侧位片JSON)》中定义的 JSON 结构。
(样例: 全景片成功)
{
  "taskId": "task-uuid-pano-...",
  "status": "SUCCESS",
  "timestamp": "2025-10-28T14:35:10Z",
  "metadata": { // 甲方传入的完整 metadata
     "patientId": "P-12345",  
     "orderId": "O-67890"  
  }, 
    "requestParameters": { // 原始请求的关键参数
      "taskType": "panoramic",  
      "imageUrl": "https://example.com/images/pano-001.jpg" 
  },
  "data": {
    //// 这里是《规范 : 全景片 JSON》的完整内容//"Metadata": { "ImageName": "panoramic_xray_001.jpg", ... },
    "JointAndMandible": { ... },
    "MaxillarySinus": [ ... ],
    "ToothAnalysis": [ ... ]
  },
  "error": null
}
(样例: 侧位片成功)
{
  "taskId": "task-uuid-ceph-...",
  "status": "SUCCESS",
  "timestamp": "2025-10-28T14:36:15Z",
  "metadata": { // 甲方传入的完整 metadata
     "patientId": "P-12345",  
     "orderId": "O-67890"  
  }, 
    "requestParameters": { // 原始请求的关键参数
      "taskType": "panoramic",  
      "imageUrl": "https://example.com/images/pano-001.jpg" 
  },
  "data": {
    //// 这里是《规范 : 侧位片 JSON》的完整内容//"ImageSpacing": { ... },
    "VisibilityMetrics": { ... },
    "CephalometricMeasurements": { ... },
    "KeyPoints": [ ... ],
    "Measurements": [ ... ]
  },
  "error": null
}
B. 状态 (Status) = FAILURE
- data 字段为 null。
- error 字段将包含错误响应体 (见 1.2.1)。
(样例: 任务失败)
{
  "taskId": "task-uuid-pano-failed-...",
  "status": "FAILURE",
  "timestamp": "2025-10-28T14:37:00Z",
  "metadata": { // 甲方传入的完整 metadata
     "patientId": "P-12345",  
     "orderId": "O-67890"  
  }, 
    "requestParameters": { // 原始请求的关键参数
      "taskType": "panoramic",  
      "imageUrl": "https://example.com/images/pano-001.jpg" 
  },
  "data": null,
  "error": {
    "code": 11003,
    "message": "Image quality too low, landmarks undetected.",
    "displayMessage": "图像质量过低，无法进行分析"
  }
}

1.3.4 甲方回调接收规范 
1. 立即响应: [甲方] 必须在收到回调请求后，在 3 秒内返回 HTTP 200 OK 响应，表示“已收到”。
  - 注意: 甲方应先返回 200，再异步处理回调数据。禁止在回调请求的同步连接中执行复杂业务。
2. 幂等性: 由于网络原因或乙方重试，[甲方] 可能会多次收到相同 taskId 的回调。
  - [甲方] 必须基于 taskId 进行幂等性检查。如果一个 taskId 已被成功处理，后续的重复回调应直接返回 HTTP 200 OK，不再重复处理业务。
3. 失败响应: 如果甲方返回 HTTP 5xx 或 HTTP 429 或超时 (超过 3 秒)，乙方将认为回调失败，并重试。

---

1.4 任务队列与执行规范

1.4.1 任务队列 
- 乙方内部使用独立的队列来隔离全景，侧位 两种不同类型的任务。
- 死信队列 (DLQ): 如果一个任务在乙方内部执行时（非回调）多次重试后仍失败（如模型 Bug），该任务将被移入“死信队列”，由乙方工程师人工介入。

1.4.2 超时 
- 任务执行超时: 任何 AI 分析任务（全景或侧位）在乙方系统内的最大执行时间被限制为 5 分钟。超过此时间，任务将被标记为失败（错误码 12002），并触发 FAILURE 回调。
- 回调超时: 乙方在 POST 回调给甲方时，等待甲方 HTTP 200 OK 的超时时间为 3 秒。

1.4.3 重试策略 
仅当乙方 POST 回调给甲方 callbackUrl 时，发生以下情况，乙方将自动重试回调：
- 甲方返回 HTTP 5xx (如 500, 503)。
- 甲方返回 HTTP 429 (请求过载)。
- 甲方连接超时 (超过 3 秒)。
- DNS 解析失败或 TCP 连接错误。
重试策略: 指数退避 (Exponential Backoff) + 抖动 (Jitter)。
- 第 1 次: 10 秒后
- 第 2 次: 30 秒后
- 第 3 次: 2 分钟后
- 第 4 次: 10 分钟后
- 第 5 次 (最后一次): 30 分钟后
如果 5 次重试后仍失败，乙方将停止回调，并将该事件记录到告警系统，由人工介入。
不会重试的情况：
- 甲方返回 HTTP 200 OK (已成功)。
- 甲方返回 HTTP 4xx (如 400, 401, 403, 404)。这表示甲方的接收端点配置错误，乙方将立即停止重试。

2 规范 : 全景片 JSON


3 规范 : 侧位片 JSON

