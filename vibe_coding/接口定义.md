
1 通用系统规范 

本规范定义了 AI 分析服务的通用技术标准，旨在确保服务调用方（甲方）与服务提供方（乙方）之间通信的标准化、可靠性、安全性和弹性。
所有 AI 分析接口（包括但不限于全景片、侧位片）均须遵守本规范。
1.1 接口状态码 

HTTP 状态码用于表示 API 接口请求的宏观结果。
	含义	描述
202 Accepted	(异步) 任务已接受	（核心） 异步任务提交成功。表示服务器已收到请求，并已将其放入处理队列。响应体中将包含 taskId。
200 OK	(同步) 请求成功	用于同步请求的成功响应，例如查询任务状态 (GET /api/v1/task/status/{taskId})。
400 Bad Request	客户端请求错误	提交的请求体格式错误（如无效 JSON）、缺少必要参数（如 imageUrl 或 callbackUrl）。
401 Unauthorized	认证失败	未提供 API-KEY 或 API-KEY 无效。
403 Forbidden	权限不足	API-KEY 有效，但无权访问此特定资源或操作。
404 Not Found	资源未找到	调用的 API 终结点 (Endpoint) 不存在，或查询的 taskId 不存在。
429 Too Many Requests	请求过载	触发了接口的速率限制 (Rate Limit)。
500 Internal Server Error	服务端内部错误	乙方服务器在处理请求时发生意外，这是乙方的 Bug。
503 Service Unavailable	 服务不可用	乙方服务暂时过载、正在停机维护或熔断。

 1.2 业务错误码 
业务错误码是对 4xx 和 5xx 状态码的详细补充，用于在同步响应或异步回调中提供具体的失败原因。

 1.2.1 错误响应体 
所有错误响应（包括同步4xx/5xx和异步回调的error字段）均使用此结构：
{
  "code": 11001, // 唯一的数字错误码
  "message": "Image file is corrupted or unreadable.", // 给开发者的调试信息
  "displayMessage": "图像文件已损坏或无法读取" // 可直接展示给终端用户的提示
}

 1.2.2 错误码定义表

状态码	含义	描述
202 Accepted	(异步) 任务已接受	（核心） 异步任务提交成功。表示服务器已收到请求，并已将其放入处理队列。响应体中将包含 taskId。
200 OK	(同步) 请求成功	用于同步请求的成功响应，例如查询任务状态 (GET /api/v1/task/status/{taskId})。
400 Bad Request	客户端请求错误	提交的请求体格式错误（如无效 JSON）、缺少必要参数（如 imageUrl 或 callbackUrl）。
401 Unauthorized	认证失败	未提供 API-KEY 或 API-KEY 无效。
403 Forbidden	权限不足	API-KEY 有效，但无权访问此特定资源或操作。
404 Not Found	资源未找到	调用的 API 终结点 (Endpoint) 不存在，或查询的 taskId 不存在。
429 Too Many Requests	请求过载	触发了接口的速率限制 (Rate Limit)。
500 Internal Server Error	服务端内部错误	乙方服务器在处理请求时发生意外，这是乙方的 Bug。
503 Service Unavailable	 服务不可用	乙方服务暂时过载、正在停机维护或熔断。
---

1.3 接口调用规范 

本系统提供四个接口，支持五种类型的前端调用：
- **接口1**: POST /api/v1/analyze - 同步推理接口（支持三种 taskType：panoramic、cephalometric、dental_age_stage）
- **接口2**: POST /api/v1/analyze_async - 异步推理接口（支持三种 taskType：panoramic、cephalometric、dental_age_stage）
- **接口3**: POST /api/v1/measurements/pano/recalculate - 全景片计算接口（纯数值计算，不涉及模型推理）
- **接口4**: POST /api/v1/measurements/ceph/recalculate - 侧位片计算接口（纯数值计算，不涉及模型推理）

**五种调用类型**：
1. 全景片推理（通过接口1或接口2，taskType="panoramic"，支持同步/异步两种模式）
2. 侧位片推理（通过接口1或接口2，taskType="cephalometric"，支持同步/异步两种模式）
3. 牙期检测推理（通过接口1或接口2，taskType="dental_age_stage"，支持同步/异步两种模式）
4. 全景片计算（接口3，接收修改后的检测结果，重新生成完整报告）
5. 侧位片计算（接口4，接收修改后的关键点坐标，重新计算测量值和生成完整报告）

所有接口均以 JSON 格式发送和接收数据。

1.3.1 推理接口 - 同步调用模式
当甲方需要同步获取推理结果时，使用同步调用模式。同步调用不需要提供 callbackUrl，推理完成后直接返回结果。

**请求参数说明**：
- taskId: (必填) 任务唯一标识（UUID v4 格式），由客户端提供。**推理任务中 taskId 必须唯一**，用于标识模型推理任务，服务端会检查 taskId 是否已存在以防止重复提交。
- taskType: (必填) 字符串。用于指定分析类型。
  - "panoramic": 全景片分析
  - "cephalometric": 侧位片分析
  - "dental_age_stage": 牙期检测（基于牙齿分割）
- imageUrl: (必填) 图像URL，与 dicomUrl 二选一
- dicomUrl: (可选) DICOM文件URL，与 imageUrl 二选一。提供时自动解析患者信息和比例尺
- patientInfo: 当 taskType 为 "cephalometric"（侧位片）时必填，包含患者性别信息和牙期信息(恒牙期还是替牙期)
- pixelSpacing: (可选) 像素间距/比例尺信息，格式: `{"scaleX": 0.1, "scaleY": 0.1}`，单位 mm/pixel。优先级：请求 pixelSpacing > DICOM解析 > 默认值(0.1)
- metadata: (可选) 元数据信息

**注意**：同步调用不需要提供 callbackUrl，推理完成后直接返回结果。taskId 必须由客户端提供，服务端不管理数据库。

**请求示例（全景片）**：
{
  "taskId": "task-uuid-a1b2c3d4-xxxx-yyyy-zzzz",
  "taskType": "panoramic",
  "imageUrl": "https://example.com/images/pano-001.jpg",
  "metadata": { 
    "patientId": "P-12345",
    "orderId": "O-67890"
  }
}

**请求示例（侧位片）**：
{
  "taskId": "task-uuid-a1b2c3d4-xxxx-yyyy-zzzz",
  "taskType": "cephalometric",
  "imageUrl": "https://example.com/images/ceph-001.jpg",
  "patientInfo": { // 侧位片必填
    "gender": "Male", // Male(男性)/Female(女性)
    "DentalAgeStage": "Permanent" // Permanent(恒牙期)/Mixed(替牙期)
  },
  "metadata": { 
    "patientId": "P-12345",
    "orderId": "O-67890"
  }
}

**请求示例（牙期检测）**：
{
  "taskId": "task-uuid-a1b2c3d4-xxxx-yyyy-zzzz",
  "taskType": "dental_age_stage",
  "imageUrl": "https://example.com/images/pano-001.jpg",
  "metadata": { 
    "patientId": "P-12345",
    "orderId": "O-67890"
  }
}

**验证与响应**：
1. [乙方] 同步验证请求。
  - 乙方将首先检查 taskId 字段（必填，UUID v4 格式）。
  - 乙方将检查 taskId 是否已存在（推理任务中 taskId 必须唯一，防止重复提交）。
  - 乙方将检查 taskType 字段。
  - 如果 taskType 为 "cephalometric"，乙方将额外验证 patientInfo.gender（患者性别信息，牙期信息(恒牙期还是替牙期)） 是否存在。
  - 验证通过 (成功): 执行推理，完成后返回 HTTP 200 OK，响应体直接包含完整的推理结果 JSON
    - taskType="panoramic"：返回《规范 : 全景片 JSON》
    - taskType="cephalometric"：返回《规范：侧位片 JSON》
    - taskType="dental_age_stage"：返回牙期检测结果（包含 dentalAgeStage 和 teethAnalysis）
  - 验证失败 (失败): 立即返回 HTTP 400 (或其他 4xx)，并在 Body 中提供错误响应体 (见 1.2.2)

**同步响应示例（全景片成功）**：
// HTTP 200 OK
{
  "taskId": "task-uuid-pano-sync-...",
  "status": "SUCCESS",
  "timestamp": "2025-10-28T14:35:10Z",
  "metadata": { 
    "patientId": "P-12345",  
    "orderId": "O-67890"  
  },
  "data": {
    // 这里是《规范 : 全景片 JSON》的完整内容
    "JointAndMandible": { ... },
    "MaxillarySinus": [ ... ],
    "ToothAnalysis": [ ... ]
  },
  "error": null
}

**同步响应示例（侧位片成功）**：
// HTTP 200 OK
{
  "taskId": "task-uuid-ceph-sync-...",
  "status": "SUCCESS",
  "timestamp": "2025-10-28T14:36:15Z",
  "metadata": { 
    "patientId": "P-12345",  
    "orderId": "O-67890"  
  },
  "data": {
    // 这里是《规范 : 侧位片 JSON》的完整内容
    "ImageSpacing": { ... },
    "VisibilityMetrics": { ... },
    "CephalometricMeasurements": { ... },
    "KeyPoints": [ ... ],
    "Measurements": [ ... ]
  },
  "error": null
}

**同步响应示例（牙期检测成功）**：
// HTTP 200 OK
{
  "taskId": "task-uuid-dental-age-sync-...",
  "status": "SUCCESS",
  "timestamp": "2025-10-28T14:37:00Z",
  "metadata": { 
    "patientId": "P-12345",  
    "orderId": "O-67890"  
  },
  "data": {
    "dentalAgeStage": "Mixed",  // "Mixed" | "Permanent"
    "teethAnalysis": {
      "totalDetected": 28,
      "deciduousCount": 4,
      "permanentCount": 24,
      "deciduousTeeth": ["51", "52", "61", "62"],
      "permanentTeeth": ["11", "12", "13", ...]
    }
  },
  "error": null
}

**同步响应示例（失败）**：
// HTTP 400 Bad Request
{
  "code": 11003,
  "message": "Image quality too low, landmarks undetected.",
  "displayMessage": "图像质量过低，无法进行分析"
}

1.3.2 推理接口 - 异步调用模式
当甲方需要异步处理推理任务时，使用异步调用模式。异步调用必须提供 callbackUrl，推理完成后通过回调通知甲方。

**请求参数说明**：
- taskId: (必填) 任务唯一标识（UUID v4 格式）
- taskType: (必填) 字符串。用于指定分析类型。
  - "panoramic": 全景片分析
  - "cephalometric": 侧位片分析
  - "dental_age_stage": 牙期检测（基于牙齿分割）
- imageUrl: (必填) 图像URL，与 dicomUrl 二选一
- dicomUrl: (可选) DICOM文件URL，与 imageUrl 二选一。提供时自动解析患者信息和比例尺
- callbackUrl: (必填) 异步回调URL，推理完成后将向此URL发送POST请求
- patientInfo: 当 taskType 为 "cephalometric"（侧位片）时必填，包含患者性别信息和牙期信息(恒牙期还是替牙期)
- pixelSpacing: (可选) 像素间距/比例尺信息，格式: `{"scaleX": 0.1, "scaleY": 0.1}`，单位 mm/pixel。优先级：请求 pixelSpacing > DICOM解析 > 默认值(0.1)
- metadata: (可选) 元数据信息

**注意**：异步调用必须提供 callbackUrl，推理完成后通过回调通知甲方。

**请求示例（全景片）**：
{
  "taskId": "task-uuid-a1b2c3d4-xxxx-yyyy-zzzz",
  "taskType": "panoramic",
  "imageUrl": "https://example.com/images/pano-001.jpg",
  "callbackUrl": "https://api.jiǎfang.com/v1/ai-callback",
  "metadata": { 
    "patientId": "P-12345",
    "orderId": "O-67890"
  }
}

**请求示例（侧位片）**：
{
  "taskId": "task-uuid-a1b2c3d4-xxxx-yyyy-zzzz",
  "taskType": "cephalometric",
  "imageUrl": "https://example.com/images/ceph-001.jpg",
  "callbackUrl": "https://api.jiǎfang.com/v1/ai-callback",
  "patientInfo": { // 侧位片必填
    "gender": "Male", // Male(男性)/Female(女性)
    "DentalAgeStage": "Permanent" // Permanent(恒牙期)/Mixed(替牙期)
  },
  "metadata": { 
    "patientId": "P-12345",
    "orderId": "O-67890"
  }
}

**请求示例（牙期检测）**：
{
  "taskId": "task-uuid-a1b2c3d4-xxxx-yyyy-zzzz",
  "taskType": "dental_age_stage",
  "imageUrl": "https://example.com/images/pano-001.jpg",
  "callbackUrl": "https://api.jiǎfang.com/v1/ai-callback",
  "metadata": { 
    "patientId": "P-12345",
    "orderId": "O-67890"
  }
}

**验证与响应**：
1. [乙方] 同步验证请求。
  - 乙方将首先检查 taskId 是否已存在（推理任务中 taskId 必须唯一，防止重复提交）。
  - 乙方将检查 taskType 字段。
  - 如果 taskType 为 "cephalometric"，乙方将额外验证 patientInfo.gender（患者性别信息，牙期信息(恒牙期还是替牙期)） 是否存在。
  - 验证通过 (成功): 立即返回 HTTP 202 Accepted，并在 Body 中提供任务 ID。任务状态 (Status) = QUEUED
  - 验证失败 (失败): 立即返回 HTTP 400 (或其他 4xx)，并在 Body 中提供错误响应体 (见 1.2.2)。

**异步提交响应示例**：
// HTTP 202 Accepted 的响应体
{
  "taskId": "task-uuid-a1b2c3d4-xxxx-yyyy-zzzz",
  "status": "QUEUED", // 状态: 已入队
  "submittedAt": "2025-10-28T14:30:00Z",
  "metadata": { 
    "patientId": "P-12345",
    "orderId": "O-67890"
  }
}

**验证失败示例**：
// HTTP 400 Bad Request
{
  "code": 10001,
  "message": "Invalid parameter 'taskType', must be provided.",
  "displayMessage": "请求参数错误：必须提供 'taskType' 字段"
}

// HTTP 400 Bad Request (侧位片任务缺少性别)
{
  "code": 10001,
  "message": "Invalid parameter 'patientInfo.gender', must be provided when taskType is 'cephalometric'.",
  "displayMessage": "请求参数错误：侧位片任务必须提供患者性别"
}

1.3.3 异步回调请求 
任务（成功或失败）后，乙方将向甲方提交的 callbackUrl 发送一个 POST 请求。
- Method: POST
- Headers:
  - Content-Type: application/json
  - X-Timestamp: 1678886400 (回调发出的 Unix 时间戳 (秒))

1.3.4 异步回调 Body - Data 与 Error
A. 状态 (Status) = SUCCESS
- error 字段为 null。
- data 字段将完整包含推理结果 JSON：
  - taskType="panoramic"：包含《规范 : 全景片 JSON》的完整内容
  - taskType="cephalometric"：包含《规范：侧位片 JSON》的完整内容
  - taskType="dental_age_stage"：包含牙期检测结果（dentalAgeStage 和 teethAnalysis）
(样例: 全景片成功)
{
  "taskId": "task-uuid-pano-...",
  "status": "SUCCESS",
  "timestamp": "2025-10-28T14:35:10Z",
  "metadata": { // 甲方传入的完整 metadata
     "patientId": "P-12345",  
     "orderId": "O-67890"  
  }, 
    "requestParameters": { // 原始请求的关键参数
      "taskType": "panoramic",  
      "imageUrl": "https://example.com/images/pano-001.jpg" 
  },
  "data": {
    //// 这里是《规范 : 全景片 JSON》的完整内容//"Metadata": { "ImageName": "panoramic_xray_001.jpg", ... },
    "JointAndMandible": { ... },
    "MaxillarySinus": [ ... ],
    "ToothAnalysis": [ ... ]
  },
  "error": null
}
(样例: 侧位片成功)
{
  "taskId": "task-uuid-ceph-...",
  "status": "SUCCESS",
  "timestamp": "2025-10-28T14:36:15Z",
  "metadata": { // 甲方传入的完整 metadata
     "patientId": "P-12345",  
     "orderId": "O-67890"  
  }, 
    "requestParameters": { // 原始请求的关键参数
      "taskType": "cephalometric",  
      "imageUrl": "https://example.com/images/ceph-001.jpg" 
  },
  "data": {
    //// 这里是《规范 : 侧位片 JSON》的完整内容//"ImageSpacing": { ... },
    "VisibilityMetrics": { ... },
    "CephalometricMeasurements": { ... },
    "KeyPoints": [ ... ],
    "Measurements": [ ... ]
  },
  "error": null
}
(样例: 牙期检测成功)
{
  "taskId": "task-uuid-dental-age-...",
  "status": "SUCCESS",
  "timestamp": "2025-10-28T14:37:00Z",
  "metadata": { // 甲方传入的完整 metadata
     "patientId": "P-12345",  
     "orderId": "O-67890"  
  }, 
    "requestParameters": { // 原始请求的关键参数
      "taskType": "dental_age_stage",  
      "imageUrl": "https://example.com/images/pano-001.jpg" 
  },
  "data": {
    "dentalAgeStage": "Mixed",  // "Mixed" | "Permanent"
    "teethAnalysis": {
      "totalDetected": 28,
      "deciduousCount": 4,
      "permanentCount": 24,
      "deciduousTeeth": ["51", "52", "61", "62"],
      "permanentTeeth": ["11", "12", "13", ...]
    }
  },
  "error": null
}
B. 状态 (Status) = FAILURE
- data 字段为 null。
- error 字段将包含错误响应体 (见 1.2.1)。
(样例: 任务失败)
{
  "taskId": "task-uuid-pano-failed-...",
  "status": "FAILURE",
  "timestamp": "2025-10-28T14:37:00Z",
  "metadata": { // 甲方传入的完整 metadata
     "patientId": "P-12345",  
     "orderId": "O-67890"  
  }, 
    "requestParameters": { // 原始请求的关键参数
      "taskType": "panoramic",  
      "imageUrl": "https://example.com/images/pano-001.jpg" 
  },
  "data": null,
  "error": {
    "code": 11003,
    "message": "Image quality too low, landmarks undetected.",
    "displayMessage": "图像质量过低，无法进行分析"
  }
}

1.3.5 甲方回调接收规范 
1. 立即响应: [甲方] 必须在收到回调请求后，在 3 秒内返回 HTTP 200 OK 响应，表示"已收到"。
  - 注意: 甲方应先返回 200，再异步处理回调数据。禁止在回调请求的同步连接中执行复杂业务。
2. 幂等性: 由于网络原因或乙方重试，[甲方] 可能会多次收到相同 taskId 的回调。
  - [甲方] 必须基于 taskId 进行幂等性检查。如果一个 taskId 已被成功处理，后续的重复回调应直接返回 HTTP 200 OK，不再重复处理业务。
3. 失败响应: 如果甲方返回 HTTP 5xx 或 HTTP 429 或超时 (超过 3 秒)，乙方将认为回调失败，并重试。

1.3.6 计算接口调用规范
计算接口用于对客户端修改后的检测结果或关键点坐标进行重新计算，生成完整的报告。计算接口不涉及模型推理，只进行纯数值计算。

**重要说明**：计算接口中的 taskId 用于标识对应的原始推理任务，**允许重复使用相同的 taskId**。这意味着可以对同一个推理结果进行多次修正计算，每次修正都使用相同的 taskId（对应原始推理任务的 taskId）。

**接口3: POST /api/v1/measurements/pano/recalculate** - 全景片计算接口

**功能**：接收客户端修改后的基础几何数据（分割掩码、检测框、分类结果），跳过模型推理，重新计算所有衍生数据（对称性判断、缺牙推导、描述文本等），返回完整的全景片报告。

> ⚠️ **服务端处理逻辑说明**：
> 本接口仅接收并处理 **基础几何数据**（"因"）。
> 请求中若包含 **衍生数据**（"果"），如"对称性判断"、"缺牙列表"、"描述文本"等，服务端将 **忽略** 这些字段的值，并基于几何数据 **重新计算并覆盖** 返回。

**因果关系说明**：

| 类别 | 字段白名单（"因" - 客户端可修改） | 说明 |
|------|----------------------------------|------|
| **元数据** | `Metadata` | ImageName, DiagnosisID, AnalysisTime（客户端传入） |
| **髁突分割** | `anatomyResults[*].SegmentationMask.Coordinates` | 髁突的多边形坐标点列表 (Label: condyle_left/condyle_right)，格式: `[[x1,y1], [x2,y2], ...]` |
| **髁突分割** | `anatomyResults[*].SegmentationMask.SerializedMask` | 髁突的 RLE 序列化掩码 (Label: condyle_left/condyle_right)，格式: `"rle:..."` |
| **下颌升支分割** | `anatomyResults[*].SegmentationMask.Coordinates` | 下颌升支的多边形坐标点列表 (Label: mandible_left/mandible_right)，格式: `[[x1,y1], [x2,y2], ...]` |
| **下颌升支分割** | `anatomyResults[*].SegmentationMask.SerializedMask` | 下颌升支的 RLE 序列化掩码 (Label: mandible_left/mandible_right)，格式: `"rle:..."` |
| **上颌窦分割** | `anatomyResults[*].SegmentationMask.Coordinates` | 上颌窦的多边形坐标点列表 (Label: sinus_left/sinus_right)，格式: `[[x1,y1], [x2,y2], ...]` |
| **上颌窦分割** | `anatomyResults[*].SegmentationMask.SerializedMask` | 上颌窦的 RLE 序列化掩码 (Label: sinus_left/sinus_right)，格式: `"rle:..."` |
| **上颌窦炎症** | `maxillarySinus[*].Inflammation` | 炎症判断 (true/false)，模型输出直接透传 |
| **上颌窦分型** | `maxillarySinus[*].TypeClassification` | 上颌窦分型 (0/1)，模型输出直接透传 |
| **牙齿编号** | `toothAnalysis[*].FDI` | 牙齿 FDI 编号 |
| **牙齿分割** | `toothAnalysis[*].SegmentationMask.Coordinates` | 牙齿的多边形坐标点列表，格式: `[[x1,y1], [x2,y2], ...]` |
| **牙齿分割** | `toothAnalysis[*].SegmentationMask.SerializedMask` | 牙齿的 RLE 序列化掩码，格式: `"rle:..."` |
| **牙齿属性** | `toothAnalysis[*].Properties` | 牙齿属性列表（模型检测结果，直接透传）：embedded_tooth(埋伏牙), restored_tooth(修复牙), carious_lesion(龋坏), residual_root(残根), residual_crown(残冠), rct_treated(根管治疗), root_absorption(牙根吸收), curved_short_root(牙根形态弯曲短小), retained_primary_tooth(滞留乳牙), Impacted(阻生) |
| **牙齿置信度** | `toothAnalysis[*].Confidence` | 牙齿检测置信度（模型输出，直接透传） |
| 髁突形态 | `condyleClassification.left/right.Morphology` | 髁突形态分类 (0=正常, 1=吸收, 2=疑似) |
| 种植体检测 | `implantItems[*].BBox` | 种植体边界框 |
| **种植体置信度** | `implantItems[*].Confidence` | 种植体检测置信度（模型输出，直接透传） |
| **智齿阻生状态** | `thirdMolarStatus[*].Impactions` | 智齿阻生判断（模型直接推理，直接透传） |
| **牙周吸收检测** | `periodontalCondition` | 牙周吸收检测结果，模型输出直接透传（无后处理逻辑） |
| **高低密度影检测** | `rootTipDensityItems[*]` | 密度影检测框+类型+置信度，模型输出直接透传（无后处理逻辑） |

| 类别 | 衍生字段（"果" - 服务端重算，客户端传值将被忽略） |
|------|--------------------------------------------------|
| **髁突对称性** | `CondyleAssessment.OverallSymmetry` - 根据左右髁突 mask 面积计算对称性等级 |
| **下颌升支对称性** | `RamusSymmetry` - 根据左右下颌升支(mandible) mask 高度计算对称性 |
| **下颌角对称性** | `GonialAngleSymmetry` - 根据左右下颌角角度计算对称性 |
| **上颌窦气化** | `MaxillarySinus[*].Pneumatization` - 根据上颌窦 mask 与 16/26 牙位距离计算等级 |
| **牙根进入上颌窦** | `MaxillarySinus[*].RootEntryToothFDI` - 从牙齿 mask 与上颌窦 mask 的交集推导 |
| 缺牙推导 | `MissingTeeth` (从检测到的牙齿列表反推) |
| 智齿Level | `ThirdMolarSummary[*].Level` (从牙齿 FDI 推导智齿存在状态：0=阻生, 1=牙胚, 2=待萌出, 4=未见) |
| 象限统计 | `ImplantAnalysis.QuadrantCounts`, `RootTipDensityAnalysis.QuadrantCounts` |
| **数量统计** | `ImplantAnalysis.TotalCount`, `RootTipDensityAnalysis.TotalCount` (从 Items 数量计算) |
| 描述文本 | 所有 `Detail` 字段 |
| 置信度(计算类) | `Confidence_Overall`, `Confidence_Pneumatization` 等服务端计算的置信度 |

> 💡 **直接透传说明**：标记为"模型输出直接透传"的字段，服务端不会对其进行二次计算或覆盖。
> 客户端传入什么值，服务端就原样使用并返回。这类字段通常是模型检测结果，我们暂无后处理逻辑。

> ⚠️ **ID字段说明**：`ImplantAnalysis.Items[*].ID` 和 `RootTipDensityAnalysis.Items[*].ID` 为预留字段，当前默认值为 "implant" / "density_*"，无实际业务逻辑。

**请求参数**：
- taskId: (必填) 任务唯一标识，仅用于日志追踪
- data: (必填) 完整的全景片推理结果 JSON（即 `example_pano_result.json` 格式）
- pixelSpacing: (可选) 像素间距/比例尺，格式: `{"scaleX": 0.1, "scaleY": 0.1}`。优先级：请求 pixelSpacing > data.ImageSpacing > 默认值(0.1)

**响应**：
- 成功: HTTP 200 OK，响应格式与推理接口一致
- 失败: HTTP 400/500 等，响应体包含错误响应体 (见 1.2.1)

**响应示例**：
```json
{
  "taskId": "task-uuid-pano-...",
  "status": "SUCCESS",
  "timestamp": "2025-10-28T14:40:00Z",
  "metadata": {
    "patientId": "P-12345",
    "orderId": "O-67890"
  },
  "data": {
    // 这里是《规范 : 全景片 JSON》的完整内容（即 example_pano_result.json 格式）
    // 其中"因"字段保持客户端传入值，"果"字段由服务端重算
    "Metadata": {...},
    "AnatomyResults": [...],
    "JointAndMandible": {...},
    "MaxillarySinus": [...],
    "PeriodontalCondition": {...},
    "MissingTeeth": [...],
    "ThirdMolarSummary": {...},
    "ImplantAnalysis": {...},
    "RootTipDensityAnalysis": {...},
    "ToothAnalysis": [...]
  },
  "error": null
}
```

**接口4: POST /api/v1/measurements/ceph/recalculate** - 侧位片计算接口

**功能**：接收客户端修改后的完整推理结果（关键点坐标 + 颈椎分割），重新计算所有测量值，生成完整的侧位片报告。

> ⚠️ **服务端处理逻辑说明**：
> 本接口接收 **完整的推理结果 JSON**（即 `example_ceph_result.json` 格式）。
> 服务端仅读取"因"字段，所有"果"字段将被 **忽略并重新计算**。

**因果关系说明**：

| 类别 | 字段白名单（"因" - 客户端传入，服务端使用） | 说明 |
|------|------------------------------------------|------|
| 图像参数 | `ImageSpacing` | 像素到毫米的比例尺 (X, Y, Unit) |
| 患者信息 | `PatientInformation.Gender` | 性别 (Male/Female) |
| 患者信息 | `PatientInformation.DentalAgeStage` | 牙期 (Permanent/Mixed) |
| **关键点坐标** | `LandmarkPositions.Landmarks[*]` | 所有关键点的 Label, X, Y, Confidence, Status |
| **颈椎分割** | `Cervical_Vertebral_Maturity_Stage.Coordinates` | 颈椎分割的多边形坐标 |
| **颈椎成熟度** | `Cervical_Vertebral_Maturity_Stage.Level` | 颈椎成熟度等级（模型直接推理） |
| **颈椎置信度** | `Cervical_Vertebral_Maturity_Stage.Confidence` | 颈椎成熟度置信度 |

| 类别 | 衍生字段（"果" - 服务端重算，客户端传值将被忽略） |
|------|--------------------------------------------------|
| 可见性评估 | `VisibilityMetrics` (Grade, MissingLandmarks) |
| 缺失点处理 | `MissingPointHandling` |
| 统计字段 | `StatisticalFields` (ProcessedLandmarks, MissingLandmarks, AverageConfidence, QualityScore) |
| 关键点统计 | `LandmarkPositions.TotalLandmarks`, `DetectedLandmarks`, `MissingLandmarks` |
| **所有测量值** | `CephalometricMeasurements.AllMeasurements[*]` 中除 `Cervical_Vertebral_Maturity_Stage` 外的所有项 |
| 测量值Level | 所有测量项的 `Level` 字段（骨性分类、角型分类等） |

> 💡 **请求格式**：直接传入完整的 `example_ceph_result.json` 格式，服务端会提取"因"字段并重算"果"字段。

**请求参数**：
- taskId: (必填) 任务唯一标识，仅用于日志追踪
- data: (必填) 完整的侧位片推理结果 JSON（即 `example_ceph_result.json` 格式）
- patientInfo: (必填) 患者信息，格式: `{"gender": "Male", "DentalAgeStage": "Permanent"}`
- pixelSpacing: (可选) 像素间距/比例尺，格式: `{"scaleX": 0.1, "scaleY": 0.1}`。优先级：请求 pixelSpacing > data.ImageSpacing > 默认值(0.1)

**响应**：
- 成功: HTTP 200 OK，响应格式与推理接口一致
- 失败: HTTP 400/500 等，响应体包含错误响应体 (见 1.2.1)

**响应示例**：
```json
{
  "taskId": "task-uuid-ceph-...",
  "status": "SUCCESS",
  "timestamp": "2025-10-28T14:40:00Z",
  "metadata": {
    "patientId": "P-12345",
    "orderId": "O-67890"
  },
  "data": {
    // 这里是《规范 : 侧位片 JSON》的完整内容（即 example_ceph_result.json 格式）
    // 其中"因"字段保持客户端传入值，"果"字段由服务端重算
    "ImageSpacing": {...},
    "VisibilityMetrics": {...},
    "PatientInformation": {...},
    "LandmarkPositions": {...},
    "CephalometricMeasurements": {...}
  },
  "error": null
}
```

---

1.4 任务队列与执行规范

1.4.1 任务队列 
- 乙方内部使用独立的队列来隔离全景，侧位 两种不同类型的任务。
- 死信队列 (DLQ): 如果一个任务在乙方内部执行时（非回调）多次重试后仍失败（如模型 Bug），该任务将被移入“死信队列”，由乙方工程师人工介入。

1.4.2 超时 
- 任务执行超时: 任何 AI 分析任务（全景或侧位）在乙方系统内的最大执行时间被限制为 5 分钟。超过此时间，任务将被标记为失败（错误码 12002）。对于同步调用，直接返回错误响应；对于异步调用，触发 FAILURE 回调。
- 回调超时: 仅适用于异步调用。乙方在 POST 回调给甲方时，等待甲方 HTTP 200 OK 的超时时间为 3 秒。

1.4.3 重试策略 
仅适用于异步调用模式。当乙方 POST 回调给甲方 callbackUrl 时，发生以下情况，乙方将自动重试回调：
- 甲方返回 HTTP 5xx (如 500, 503)。
- 甲方返回 HTTP 429 (请求过载)。
- 甲方连接超时 (超过 3 秒)。
- DNS 解析失败或 TCP 连接错误。
重试策略: 指数退避 (Exponential Backoff) + 抖动 (Jitter)。
- 第 1 次: 10 秒后
- 第 2 次: 30 秒后
- 第 3 次: 2 分钟后
- 第 4 次: 10 分钟后
- 第 5 次 (最后一次): 30 分钟后
如果 5 次重试后仍失败，乙方将停止回调，并将该事件记录到告警系统，由人工介入。
不会重试的情况：
- 甲方返回 HTTP 200 OK (已成功)。
- 甲方返回 HTTP 4xx (如 400, 401, 403, 404)。这表示甲方的接收端点配置错误，乙方将立即停止重试。

2 规范 : 全景片 JSON


3 规范 : 侧位片 JSON

