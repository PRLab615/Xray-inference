
1 通用系统规范 

本规范定义了 AI 分析服务的通用技术标准，旨在确保服务调用方（甲方）与服务提供方（乙方）之间通信的标准化、可靠性、安全性和弹性。
所有 AI 分析接口（包括但不限于全景片、侧位片）均须遵守本规范。
1.1 接口状态码 

HTTP 状态码用于表示 API 接口请求的宏观结果。
	含义	描述
202 Accepted	(异步) 任务已接受	（核心） 异步任务提交成功。表示服务器已收到请求，并已将其放入处理队列。响应体中将包含 taskId。
200 OK	(同步) 请求成功	用于同步请求的成功响应，例如查询任务状态 (GET /api/v1/task/status/{taskId})。
400 Bad Request	客户端请求错误	提交的请求体格式错误（如无效 JSON）、缺少必要参数（如 imageUrl 或 callbackUrl）。
401 Unauthorized	认证失败	未提供 API-KEY 或 API-KEY 无效。
403 Forbidden	权限不足	API-KEY 有效，但无权访问此特定资源或操作。
404 Not Found	资源未找到	调用的 API 终结点 (Endpoint) 不存在，或查询的 taskId 不存在。
429 Too Many Requests	请求过载	触发了接口的速率限制 (Rate Limit)。
500 Internal Server Error	服务端内部错误	乙方服务器在处理请求时发生意外，这是乙方的 Bug。
503 Service Unavailable	 服务不可用	乙方服务暂时过载、正在停机维护或熔断。

 1.2 业务错误码 
业务错误码是对 4xx 和 5xx 状态码的详细补充，用于在同步响应或异步回调中提供具体的失败原因。

 1.2.1 错误响应体 
所有错误响应（包括同步4xx/5xx和异步回调的error字段）均使用此结构：
{
  "code": 11001, // 唯一的数字错误码
  "message": "Image file is corrupted or unreadable.", // 给开发者的调试信息
  "displayMessage": "图像文件已损坏或无法读取" // 可直接展示给终端用户的提示
}

 1.2.2 错误码定义表

状态码	含义	描述
202 Accepted	(异步) 任务已接受	（核心） 异步任务提交成功。表示服务器已收到请求，并已将其放入处理队列。响应体中将包含 taskId。
200 OK	(同步) 请求成功	用于同步请求的成功响应，例如查询任务状态 (GET /api/v1/task/status/{taskId})。
400 Bad Request	客户端请求错误	提交的请求体格式错误（如无效 JSON）、缺少必要参数（如 imageUrl 或 callbackUrl）。
401 Unauthorized	认证失败	未提供 API-KEY 或 API-KEY 无效。
403 Forbidden	权限不足	API-KEY 有效，但无权访问此特定资源或操作。
404 Not Found	资源未找到	调用的 API 终结点 (Endpoint) 不存在，或查询的 taskId 不存在。
429 Too Many Requests	请求过载	触发了接口的速率限制 (Rate Limit)。
500 Internal Server Error	服务端内部错误	乙方服务器在处理请求时发生意外，这是乙方的 Bug。
503 Service Unavailable	 服务不可用	乙方服务暂时过载、正在停机维护或熔断。
---

1.3 接口调用规范 

本系统提供四个接口，支持五种类型的前端调用：
- **接口1**: POST /api/v1/analyze - 同步推理接口（支持三种 taskType：panoramic、cephalometric、dental_age_stage）
- **接口2**: POST /api/v1/analyze_async - 异步推理接口（支持三种 taskType：panoramic、cephalometric、dental_age_stage）
- **接口3**: POST /api/v1/measurements/pano/recalculate - 全景片计算接口（纯数值计算，不涉及模型推理）
- **接口4**: POST /api/v1/measurements/ceph/recalculate - 侧位片计算接口（纯数值计算，不涉及模型推理）

**五种调用类型**：
1. 全景片推理（通过接口1或接口2，taskType="panoramic"，支持同步/异步两种模式）
2. 侧位片推理（通过接口1或接口2，taskType="cephalometric"，支持同步/异步两种模式）
3. 牙期检测推理（通过接口1或接口2，taskType="dental_age_stage"，支持同步/异步两种模式）
4. 全景片计算（接口3，接收修改后的检测结果，重新生成完整报告）
5. 侧位片计算（接口4，接收修改后的关键点坐标，重新计算测量值和生成完整报告）

所有接口均以 JSON 格式发送和接收数据。

1.3.1 推理接口 - 同步调用模式
当甲方需要同步获取推理结果时，使用同步调用模式。同步调用不需要提供 callbackUrl，推理完成后直接返回结果。

**请求参数说明**：
- taskId: (必填) 任务唯一标识（UUID v4 格式），由客户端提供。**推理任务中 taskId 必须唯一**，用于标识模型推理任务，服务端会检查 taskId 是否已存在以防止重复提交。
- taskType: (必填) 字符串。用于指定分析类型。
  - "panoramic": 全景片分析
  - "cephalometric": 侧位片分析
  - "dental_age_stage": 牙期检测（基于牙齿分割）
- imageUrl: (必填) 图像URL
- patientInfo: 当 taskType 为 "cephalometric"（侧位片）时必填，包含患者性别信息和牙期信息(恒牙期还是替牙期)
- metadata: (可选) 元数据信息

**注意**：同步调用不需要提供 callbackUrl，推理完成后直接返回结果。taskId 必须由客户端提供，服务端不管理数据库。

**请求示例（全景片）**：
{
  "taskId": "task-uuid-a1b2c3d4-xxxx-yyyy-zzzz",
  "taskType": "panoramic",
  "imageUrl": "https://example.com/images/pano-001.jpg",
  "metadata": { 
    "patientId": "P-12345",
    "orderId": "O-67890"
  }
}

**请求示例（侧位片）**：
{
  "taskId": "task-uuid-a1b2c3d4-xxxx-yyyy-zzzz",
  "taskType": "cephalometric",
  "imageUrl": "https://example.com/images/ceph-001.jpg",
  "patientInfo": { // 侧位片必填
    "gender": "Male", // Male(男性)/Female(女性)
    "DentalAgeStage": "Permanent" // Permanent(恒牙期)/Mixed(替牙期)
  },
  "metadata": { 
    "patientId": "P-12345",
    "orderId": "O-67890"
  }
}

**请求示例（牙期检测）**：
{
  "taskId": "task-uuid-a1b2c3d4-xxxx-yyyy-zzzz",
  "taskType": "dental_age_stage",
  "imageUrl": "https://example.com/images/pano-001.jpg",
  "metadata": { 
    "patientId": "P-12345",
    "orderId": "O-67890"
  }
}

**验证与响应**：
1. [乙方] 同步验证请求。
  - 乙方将首先检查 taskId 字段（必填，UUID v4 格式）。
  - 乙方将检查 taskId 是否已存在（推理任务中 taskId 必须唯一，防止重复提交）。
  - 乙方将检查 taskType 字段。
  - 如果 taskType 为 "cephalometric"，乙方将额外验证 patientInfo.gender（患者性别信息，牙期信息(恒牙期还是替牙期)） 是否存在。
  - 验证通过 (成功): 执行推理，完成后返回 HTTP 200 OK，响应体直接包含完整的推理结果 JSON
    - taskType="panoramic"：返回《规范 : 全景片 JSON》
    - taskType="cephalometric"：返回《规范：侧位片 JSON》
    - taskType="dental_age_stage"：返回牙期检测结果（包含 dentalAgeStage 和 teethAnalysis）
  - 验证失败 (失败): 立即返回 HTTP 400 (或其他 4xx)，并在 Body 中提供错误响应体 (见 1.2.2)

**同步响应示例（全景片成功）**：
// HTTP 200 OK
{
  "taskId": "task-uuid-pano-sync-...",
  "status": "SUCCESS",
  "timestamp": "2025-10-28T14:35:10Z",
  "metadata": { 
    "patientId": "P-12345",  
    "orderId": "O-67890"  
  },
  "data": {
    // 这里是《规范 : 全景片 JSON》的完整内容
    "JointAndMandible": { ... },
    "MaxillarySinus": [ ... ],
    "ToothAnalysis": [ ... ]
  },
  "error": null
}

**同步响应示例（侧位片成功）**：
// HTTP 200 OK
{
  "taskId": "task-uuid-ceph-sync-...",
  "status": "SUCCESS",
  "timestamp": "2025-10-28T14:36:15Z",
  "metadata": { 
    "patientId": "P-12345",  
    "orderId": "O-67890"  
  },
  "data": {
    // 这里是《规范 : 侧位片 JSON》的完整内容
    "ImageSpacing": { ... },
    "VisibilityMetrics": { ... },
    "CephalometricMeasurements": { ... },
    "KeyPoints": [ ... ],
    "Measurements": [ ... ]
  },
  "error": null
}

**同步响应示例（牙期检测成功）**：
// HTTP 200 OK
{
  "taskId": "task-uuid-dental-age-sync-...",
  "status": "SUCCESS",
  "timestamp": "2025-10-28T14:37:00Z",
  "metadata": { 
    "patientId": "P-12345",  
    "orderId": "O-67890"  
  },
  "data": {
    "dentalAgeStage": "Mixed",  // "Mixed" | "Permanent"
    "teethAnalysis": {
      "totalDetected": 28,
      "deciduousCount": 4,
      "permanentCount": 24,
      "deciduousTeeth": ["51", "52", "61", "62"],
      "permanentTeeth": ["11", "12", "13", ...]
    }
  },
  "error": null
}

**同步响应示例（失败）**：
// HTTP 400 Bad Request
{
  "code": 11003,
  "message": "Image quality too low, landmarks undetected.",
  "displayMessage": "图像质量过低，无法进行分析"
}

1.3.2 推理接口 - 异步调用模式
当甲方需要异步处理推理任务时，使用异步调用模式。异步调用必须提供 callbackUrl，推理完成后通过回调通知甲方。

**请求参数说明**：
- taskId: (必填) 任务唯一标识（UUID v4 格式）
- taskType: (必填) 字符串。用于指定分析类型。
  - "panoramic": 全景片分析
  - "cephalometric": 侧位片分析
  - "dental_age_stage": 牙期检测（基于牙齿分割）
- imageUrl: (必填) 图像URL
- callbackUrl: (必填) 异步回调URL，推理完成后将向此URL发送POST请求
- patientInfo: 当 taskType 为 "cephalometric"（侧位片）时必填，包含患者性别信息和牙期信息(恒牙期还是替牙期)
- metadata: (可选) 元数据信息

**注意**：异步调用必须提供 callbackUrl，推理完成后通过回调通知甲方。

**请求示例（全景片）**：
{
  "taskId": "task-uuid-a1b2c3d4-xxxx-yyyy-zzzz",
  "taskType": "panoramic",
  "imageUrl": "https://example.com/images/pano-001.jpg",
  "callbackUrl": "https://api.jiǎfang.com/v1/ai-callback",
  "metadata": { 
    "patientId": "P-12345",
    "orderId": "O-67890"
  }
}

**请求示例（侧位片）**：
{
  "taskId": "task-uuid-a1b2c3d4-xxxx-yyyy-zzzz",
  "taskType": "cephalometric",
  "imageUrl": "https://example.com/images/ceph-001.jpg",
  "callbackUrl": "https://api.jiǎfang.com/v1/ai-callback",
  "patientInfo": { // 侧位片必填
    "gender": "Male", // Male(男性)/Female(女性)
    "DentalAgeStage": "Permanent" // Permanent(恒牙期)/Mixed(替牙期)
  },
  "metadata": { 
    "patientId": "P-12345",
    "orderId": "O-67890"
  }
}

**请求示例（牙期检测）**：
{
  "taskId": "task-uuid-a1b2c3d4-xxxx-yyyy-zzzz",
  "taskType": "dental_age_stage",
  "imageUrl": "https://example.com/images/pano-001.jpg",
  "callbackUrl": "https://api.jiǎfang.com/v1/ai-callback",
  "metadata": { 
    "patientId": "P-12345",
    "orderId": "O-67890"
  }
}

**验证与响应**：
1. [乙方] 同步验证请求。
  - 乙方将首先检查 taskId 是否已存在（推理任务中 taskId 必须唯一，防止重复提交）。
  - 乙方将检查 taskType 字段。
  - 如果 taskType 为 "cephalometric"，乙方将额外验证 patientInfo.gender（患者性别信息，牙期信息(恒牙期还是替牙期)） 是否存在。
  - 验证通过 (成功): 立即返回 HTTP 202 Accepted，并在 Body 中提供任务 ID。任务状态 (Status) = QUEUED
  - 验证失败 (失败): 立即返回 HTTP 400 (或其他 4xx)，并在 Body 中提供错误响应体 (见 1.2.2)。

**异步提交响应示例**：
// HTTP 202 Accepted 的响应体
{
  "taskId": "task-uuid-a1b2c3d4-xxxx-yyyy-zzzz",
  "status": "QUEUED", // 状态: 已入队
  "submittedAt": "2025-10-28T14:30:00Z",
  "metadata": { 
    "patientId": "P-12345",
    "orderId": "O-67890"
  }
}

**验证失败示例**：
// HTTP 400 Bad Request
{
  "code": 10001,
  "message": "Invalid parameter 'taskType', must be provided.",
  "displayMessage": "请求参数错误：必须提供 'taskType' 字段"
}

// HTTP 400 Bad Request (侧位片任务缺少性别)
{
  "code": 10001,
  "message": "Invalid parameter 'patientInfo.gender', must be provided when taskType is 'cephalometric'.",
  "displayMessage": "请求参数错误：侧位片任务必须提供患者性别"
}

1.3.3 异步回调请求 
任务（成功或失败）后，乙方将向甲方提交的 callbackUrl 发送一个 POST 请求。
- Method: POST
- Headers:
  - Content-Type: application/json
  - X-Timestamp: 1678886400 (回调发出的 Unix 时间戳 (秒))

1.3.4 异步回调 Body - Data 与 Error
A. 状态 (Status) = SUCCESS
- error 字段为 null。
- data 字段将完整包含推理结果 JSON：
  - taskType="panoramic"：包含《规范 : 全景片 JSON》的完整内容
  - taskType="cephalometric"：包含《规范：侧位片 JSON》的完整内容
  - taskType="dental_age_stage"：包含牙期检测结果（dentalAgeStage 和 teethAnalysis）
(样例: 全景片成功)
{
  "taskId": "task-uuid-pano-...",
  "status": "SUCCESS",
  "timestamp": "2025-10-28T14:35:10Z",
  "metadata": { // 甲方传入的完整 metadata
     "patientId": "P-12345",  
     "orderId": "O-67890"  
  }, 
    "requestParameters": { // 原始请求的关键参数
      "taskType": "panoramic",  
      "imageUrl": "https://example.com/images/pano-001.jpg" 
  },
  "data": {
    //// 这里是《规范 : 全景片 JSON》的完整内容//"Metadata": { "ImageName": "panoramic_xray_001.jpg", ... },
    "JointAndMandible": { ... },
    "MaxillarySinus": [ ... ],
    "ToothAnalysis": [ ... ]
  },
  "error": null
}
(样例: 侧位片成功)
{
  "taskId": "task-uuid-ceph-...",
  "status": "SUCCESS",
  "timestamp": "2025-10-28T14:36:15Z",
  "metadata": { // 甲方传入的完整 metadata
     "patientId": "P-12345",  
     "orderId": "O-67890"  
  }, 
    "requestParameters": { // 原始请求的关键参数
      "taskType": "cephalometric",  
      "imageUrl": "https://example.com/images/ceph-001.jpg" 
  },
  "data": {
    //// 这里是《规范 : 侧位片 JSON》的完整内容//"ImageSpacing": { ... },
    "VisibilityMetrics": { ... },
    "CephalometricMeasurements": { ... },
    "KeyPoints": [ ... ],
    "Measurements": [ ... ]
  },
  "error": null
}
(样例: 牙期检测成功)
{
  "taskId": "task-uuid-dental-age-...",
  "status": "SUCCESS",
  "timestamp": "2025-10-28T14:37:00Z",
  "metadata": { // 甲方传入的完整 metadata
     "patientId": "P-12345",  
     "orderId": "O-67890"  
  }, 
    "requestParameters": { // 原始请求的关键参数
      "taskType": "dental_age_stage",  
      "imageUrl": "https://example.com/images/pano-001.jpg" 
  },
  "data": {
    "dentalAgeStage": "Mixed",  // "Mixed" | "Permanent"
    "teethAnalysis": {
      "totalDetected": 28,
      "deciduousCount": 4,
      "permanentCount": 24,
      "deciduousTeeth": ["51", "52", "61", "62"],
      "permanentTeeth": ["11", "12", "13", ...]
    }
  },
  "error": null
}
B. 状态 (Status) = FAILURE
- data 字段为 null。
- error 字段将包含错误响应体 (见 1.2.1)。
(样例: 任务失败)
{
  "taskId": "task-uuid-pano-failed-...",
  "status": "FAILURE",
  "timestamp": "2025-10-28T14:37:00Z",
  "metadata": { // 甲方传入的完整 metadata
     "patientId": "P-12345",  
     "orderId": "O-67890"  
  }, 
    "requestParameters": { // 原始请求的关键参数
      "taskType": "panoramic",  
      "imageUrl": "https://example.com/images/pano-001.jpg" 
  },
  "data": null,
  "error": {
    "code": 11003,
    "message": "Image quality too low, landmarks undetected.",
    "displayMessage": "图像质量过低，无法进行分析"
  }
}

1.3.5 甲方回调接收规范 
1. 立即响应: [甲方] 必须在收到回调请求后，在 3 秒内返回 HTTP 200 OK 响应，表示"已收到"。
  - 注意: 甲方应先返回 200，再异步处理回调数据。禁止在回调请求的同步连接中执行复杂业务。
2. 幂等性: 由于网络原因或乙方重试，[甲方] 可能会多次收到相同 taskId 的回调。
  - [甲方] 必须基于 taskId 进行幂等性检查。如果一个 taskId 已被成功处理，后续的重复回调应直接返回 HTTP 200 OK，不再重复处理业务。
3. 失败响应: 如果甲方返回 HTTP 5xx 或 HTTP 429 或超时 (超过 3 秒)，乙方将认为回调失败，并重试。

1.3.6 计算接口调用规范
计算接口用于对客户端修改后的检测结果或关键点坐标进行重新计算，生成完整的报告。计算接口不涉及模型推理，只进行纯数值计算。

**重要说明**：计算接口中的 taskId 用于标识对应的原始推理任务，**允许重复使用相同的 taskId**。这意味着可以对同一个推理结果进行多次修正计算，每次修正都使用相同的 taskId（对应原始推理任务的 taskId）。

**接口3: POST /api/v1/measurements/pano/recalculate** - 全景片计算接口

**功能**：接收客户端修改后的检测结果（牙齿、髁突、种植体等），跳过模型推理，直接调用报告生成函数，返回完整的全景片报告。

**请求参数**：
- taskId: (必填) 任务唯一标识（UUID v4 格式），由客户端提供。**计算接口中 taskId 可以重复**，用于标识对应的原始推理任务，允许对同一推理结果进行多次修正。
- inferenceResults: (必填) 修改后的推理结果字典，包含所有模块结果
  - condyle_seg: 髁突分割结果
  - condyle_det: 髁突检测结果
  - mandible: 下颌骨分割结果
  - implant: 种植体检测结果
  - teeth: 牙齿分割结果
- metadata: (可选) 图像元信息

**响应**：
- 成功: HTTP 200 OK，响应体包含重算后的完整全景片报告 JSON（《规范 : 全景片 JSON》）
- 失败: HTTP 400/500 等，响应体包含错误响应体 (见 1.2.1)

**请求示例**：
{
  "taskId": "task-uuid-a1b2c3d4-xxxx-yyyy-zzzz",
  "inferenceResults": {
    "teeth_seg": { ... },
    "condyle_det": { ... },
    "implant_detect": { ... },
    ...
  },
  "metadata": {
    "source": "manual_edit",
    "timestamp": 1678886400
  }
}

**响应示例**：
// HTTP 200 OK
{
  "taskId": "task-uuid-a1b2c3d4-xxxx-yyyy-zzzz",
  "status": "SUCCESS",
  "timestamp": "2025-10-28T14:40:00Z",
  "data": {
    // 这里是《规范 : 全景片 JSON》的完整内容
    "JointAndMandible": { ... },
    "MaxillarySinus": [ ... ],
    "ToothAnalysis": [ ... ]
  },
  "error": null
}

**接口4: POST /api/v1/measurements/ceph/recalculate** - 侧位片计算接口

**功能**：接收客户端修改后的关键点坐标，重新计算测量值，生成完整的侧位片报告。

**请求参数**：
- taskId: (必填) 任务唯一标识（UUID v4 格式），由客户端提供。**计算接口中 taskId 可以重复**，用于标识对应的原始推理任务，允许对同一推理结果进行多次修正。
- landmarks: (必填) 修改后的关键点坐标字典
  格式: {"S": {"x": 512.5, "y": 245.3}, "N": {"x": 508.0, "y": 312.1}, ...}
- patientInfo: (必填) 患者信息
  - gender: 性别（Male/Female）
  - DentalAgeStage: 牙期（Permanent/Mixed）
- imageSpacing: (可选) 图像间距，默认 {"X": 0.1, "Y": 0.1}

**响应**：
- 成功: HTTP 200 OK，响应体包含重算后的完整侧位片报告 JSON（《规范：侧位片 JSON》）
- 失败: HTTP 400/500 等，响应体包含错误响应体 (见 1.2.1)

**请求示例**：
{
  "taskId": "task-uuid-a1b2c3d4-xxxx-yyyy-zzzz",
  "landmarks": {
    "S": {"x": 512.5, "y": 245.3},
    "N": {"x": 508.0, "y": 312.1},
    "A": {"x": 520.0, "y": 380.0},
    ...
  },
  "patientInfo": {
    "gender": "Male",
    "DentalAgeStage": "Permanent"
  },
  "imageSpacing": {
    "X": 0.1,
    "Y": 0.1
  }
}

**响应示例**：
// HTTP 200 OK
{
  "taskId": "task-uuid-a1b2c3d4-xxxx-yyyy-zzzz",
  "status": "SUCCESS",
  "timestamp": "2025-10-28T14:40:00Z",
  "data": {
    // 这里是《规范 : 侧位片 JSON》的完整内容
    "ImageSpacing": { ... },
    "VisibilityMetrics": { ... },
    "CephalometricMeasurements": { ... },
    "KeyPoints": [ ... ],
    "Measurements": [ ... ]
  },
  "error": null
}

---

1.4 任务队列与执行规范

1.4.1 任务队列 
- 乙方内部使用独立的队列来隔离全景，侧位 两种不同类型的任务。
- 死信队列 (DLQ): 如果一个任务在乙方内部执行时（非回调）多次重试后仍失败（如模型 Bug），该任务将被移入“死信队列”，由乙方工程师人工介入。

1.4.2 超时 
- 任务执行超时: 任何 AI 分析任务（全景或侧位）在乙方系统内的最大执行时间被限制为 5 分钟。超过此时间，任务将被标记为失败（错误码 12002）。对于同步调用，直接返回错误响应；对于异步调用，触发 FAILURE 回调。
- 回调超时: 仅适用于异步调用。乙方在 POST 回调给甲方时，等待甲方 HTTP 200 OK 的超时时间为 3 秒。

1.4.3 重试策略 
仅适用于异步调用模式。当乙方 POST 回调给甲方 callbackUrl 时，发生以下情况，乙方将自动重试回调：
- 甲方返回 HTTP 5xx (如 500, 503)。
- 甲方返回 HTTP 429 (请求过载)。
- 甲方连接超时 (超过 3 秒)。
- DNS 解析失败或 TCP 连接错误。
重试策略: 指数退避 (Exponential Backoff) + 抖动 (Jitter)。
- 第 1 次: 10 秒后
- 第 2 次: 30 秒后
- 第 3 次: 2 分钟后
- 第 4 次: 10 分钟后
- 第 5 次 (最后一次): 30 分钟后
如果 5 次重试后仍失败，乙方将停止回调，并将该事件记录到告警系统，由人工介入。
不会重试的情况：
- 甲方返回 HTTP 200 OK (已成功)。
- 甲方返回 HTTP 4xx (如 400, 401, 403, 404)。这表示甲方的接收端点配置错误，乙方将立即停止重试。

2 规范 : 全景片 JSON


3 规范 : 侧位片 JSON

